<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國考互動練習系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --success: #28a745; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .setup-area { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; width: 100%; max-width: 500px; }
        .hidden { display: none; }
        
        /* Flip-board Module */
        .quiz-container { width: 100%; max-width: 600px; perspective: 1000px; }
        .flip-card { width: 100%; height: 450px; cursor: pointer; transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
        .flip-card.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; justify-content: center; box-sizing: border-box;
        }
        .card-back { transform: rotateY(180deg); background: #f0f7ff; color: var(--primary); text-align: center; }
        
        .option { margin: 8px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; text-align: left; }
        .nav { margin-top: 20px; display: flex; gap: 15px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; background: var(--primary); color: white; cursor: pointer; }
        input[type="file"] { margin: 10px 0; }
        .status { font-size: 0.9em; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

    <h2>國考互動測驗系統</h2>

    <div id="setup" class="setup-area">
        <h3>第一步：上傳檔案</h3>
        <label>1. 選擇試題 PDF (例如 114170_1101.pdf)</label><br>
        <input type="file" id="questPdf" accept="application/pdf"><br>
        <label>2. 選擇答案 PDF (例如 114170_ANS1101.pdf)</label><br>
        <input type="file" id="ansPdf" accept="application/pdf"><br>
        <button onclick="processFiles()" id="startBtn">開始解析並練習</button>
        <p class="status" id="loadStatus"></p>
    </div>

    <div id="quiz-ui" class="quiz-container hidden">
        <div id="progress">題目載入中...</div>
        <div class="flip-card" id="mainCard" onclick="this.classList.toggle('flipped')">
            <div class="card-front" id="qArea"></div>
            <div class="card-back">
                <h2>正確答案</h2>
                <h1 id="aArea" style="font-size: 80px;"></h1>
                <p>(點擊卡片回到題目)</p>
            </div>
        </div>
        <div class="nav">
            <button onclick="changeQuestion(-1)">上一題</button>
            <button onclick="changeQuestion(1)">下一題</button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let quizData = [];
        let currentIndex = 0;

        async function extractText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(item => item.str).join(" ") + "\n";
            }
            return fullText;
        }

        async function processFiles() {
            const qFile = document.getElementById('questPdf').files[0];
            const aFile = document.getElementById('ansPdf').files[0];
            const status = document.getElementById('loadStatus');

            if (!qFile || !aFile) return alert("請同時上傳試題與答案檔！");

            status.innerText = "正在讀取 PDF 內容...";
            try {
                const qText = await extractText(qFile);
                const aText = await extractText(aFile);

                // 解析答案 (對應題號與 A/B/C/D)
                const ansMap = {};
                const ansMatches = aText.match(/第(\d+)題\s+([A-D])/g) || aText.match(/(\d+)\s+([A-D])/g);
                ansMatches?.forEach(m => {
                    const parts = m.match(/(\d+).+([A-D])/);
                    if(parts) ansMap[parts[1]] = parts[2];
                });

                // 解析題目 (根據題號切分)
                for (let i = 1; i <= 50; i++) {
                    const nextNum = i + 1;
                    const regex = new RegExp(`\\s${i}\\s(.*?)(?=\\s${nextNum}\\s|$)`, 's');
                    const match = qText.match(regex);
                    if (match && ansMap[i]) {
                        quizData.push({
                            id: i,
                            question: match[1].trim(),
                            answer: ansMap[i]
                        });
                    }
                }

                if (quizData.length > 0) {
                    document.getElementById('setup').classList.add('hidden');
                    document.getElementById('quiz-ui').classList.remove('hidden');
                    renderQuestion();
                } else {
                    alert("解析失敗，請確保 PDF 格式正確。");
                }
            } catch (e) {
                console.error(e);
                status.innerText = "解析出錯：" + e.message;
            }
        }

        function renderQuestion() {
            const item = quizData[currentIndex];
            const card = document.getElementById('mainCard');
            card.classList.remove('flipped');
            
            // 簡單處理選項換行預覽
            const formattedQ = item.question.replace(/\([A-D]\)/g, '<br>$&');
            
            document.getElementById('qArea').innerHTML = `<h3>第 ${item.id} 題</h3><p>${formattedQ}</p>`;
            document.getElementById('aArea').innerText = item.answer;
            document.getElementById('progress').innerText = `目前進度：${currentIndex + 1} / ${quizData.length}`;
        }

        function changeQuestion(step) {
            currentIndex += step;
            if (currentIndex < 0) currentIndex = 0;
            if (currentIndex >= quizData.length) currentIndex = quizData.length - 1;
            renderQuestion();
        }
    </script>
</body>
</html>
